<!DOCTYPE html>
<html>
<head>
    <title>TicTacToe simple game</title>
    <style type="text/css">
        .container {           
            border: solid #808080;
            border-width: 1px;
            padding: 5px;
            margin: 1px;
        }
        table td{
            padding:10px;
            background-color: antiquewhite;
            cursor: pointer;
            width: 20px;
            height:20px;
            text-align: center;
        }
        .game-field {
            width: auto;
            height: auto;
        }
        .cell1{
            padding:10px;
            background-color: antiquewhite;
            text-align: center;
        }

    </style>
</head>
<body>
    <input type="hidden" id="playerid" value="" />
    <div class="container" id="container">
    </div>
    <p id="result"></p>
    <!--Script references. -->
    <script src="Scripts/react/react-0.13.1.js"></script>
    <script src="Scripts/react/JSXTransformer-0.13.1.js"></script>
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script type="text/jsx">
        var Gamefield = React.createClass({
        getInitialState: function() {
        var field = new Array(3);
        field[0] = [ null, null, null ];
        field[1] = [ null, null, null ];
        field[2] = [ null, null, null ];
        return {data: field, enable: true};
        },
        setMark: function(x, y, mark, enable){
        if(this.state.data[y][x]!==""){
        this.state.data[y][x]=mark;
        this.state.enable = enable;
        this.setState(this.state);
        }
        },
        setOwnMark: function(x, y) {
        if(this.state.enable){
        this.setMark(x,y,'X', false);
        return true;
        }
        return false;
        },
        setOtherMark: function(x, y) {
        this.setMark(x,y,'O', true);
        return true;
        },
        render: function() {
        return (
        <table>
            {this.state.data.map(function(row, i){
            return (
            <tr>
                {row.map(function(col, j){
                return (
                <td classname='cell1' data-valx={j} data-valy={i}>{col}</td>);
                })}
            </tr>);
            })}
        </table>);
        }
        });
        var gameFieldComponent = React.render(
        <Gamefield />,
        document.getElementById('container')
        );
    </script>
    <script type="text/javascript">

        function checkWin(field, i0, j0) {
            var max = field.length;
            var pattern = field[i0][j0];
            var check = true;
            for (var i = 0; i < max; i++) {
                if (field[i][j0] != pattern) {
                    check = false;
                    break;
                }
            }

            if (check) {
                return true;
            }

            check = true;
            for (var j = 0; j < max; j++) {
                if (field[i0][j] != pattern) {
                    check = false;
                    break;
                }
            }

            if (check) {
                return true;
            }

            if (!(i0 == j0 || i0==max-1-j0)) {
                return false;
            }

            check = true;
            for (var k = 0; k < max; k++) {
                if (field[k][k] != pattern) {
                    check = false;
                    break;
                }
            }
            if (check) {
                return true;
            }

            check = true;
            for (var k = 0; k < max; k++) {
                if (field[k][max - k - 1] != pattern) {
                    check = false;
                    break;
                }
            }
            return check;
        }
        $(function () {
            // Declare a proxy to reference the hub.
            var game = $.connection.gameHub;
            // Create a function that the hub can call to broadcast messages.
            game.client.broadcastMessage = function (id, x, y) {
                var myId = $('#playerid').val();
                var res = false;
                if (id == myId) { // draw cross
                    res = gameFieldComponent.setOwnMark(x, y);
                }
                else { // draw zero
                    res = gameFieldComponent.setOtherMark(x, y);
                }

                if (res && checkWin(gameFieldComponent.state.data, y, x)) {
                    if (id == myId) {
                        $("#result").text("You win!");
                    }
                    else {
                        $("#result").text("Another player wins :(");
                    }
                    gameFieldComponent.state.enable = false;
                }
            };

            // Start the connection.
            $.connection.hub.start().done(function () {
                game.server.register("single").done(function (cid) {
                    $('#playerid').val(cid);
                });

                $('table td').click(function (e) {
                    if ($(e.target).text() === "") {
                        var x = $(e.target).attr('data-valx');
                        var y = $(e.target).attr('data-valy');
                        if (gameFieldComponent.state.enable) {
                            game.server.send(parseInt(x), parseInt(y), "single");
                        }
                    }
                });

            });
        });
    </script>
</body>
</html>
